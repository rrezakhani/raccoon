<!DOCTYPE html><head><meta charset="UTF-8"><title>fv_design.md|RACCOON</title><link rel="icon" type="image/x-icon" href="../media/raccoon_icon.png" sizes="16x16 32x32 64x64 128x128"></link><link href="../contrib/materialize/materialize.min.css" type="text/css" rel="stylesheet" media="screen,projection"></link><link href="../contrib/prism/prism.min.css" type="text/css" rel="stylesheet"></link><link href="../css/moose.css" type="text/css" rel="stylesheet"></link><link href="../css/alert_moose.css" type="text/css" rel="stylesheet"></link><link href="../contrib/katex/katex.min.css" type="text/css" rel="stylesheet"></link><link href="../css/katex_moose.css" type="text/css" rel="stylesheet"></link><link href="../css/content_moose.css" type="text/css" rel="stylesheet"></link><link href="../css/sqa_moose.css" type="text/css" rel="stylesheet"></link><script type="text/javascript" src="../contrib/jquery/jquery.min.js"></script><script type="text/javascript" src="../contrib/katex/katex.min.js"></script><script type="text/javascript" src="../contrib/plotly/plotly.min.js"></script></head><body><div class="page-wrap"><header><nav><div class="nav-wrapper container"><a href="https://hugary1995.github.io/raccoon/index.html" class="left moose-logo hide-on-med-and-down">RACCOON</a><a href="https://github.com/hugary1995/raccoon" class="right"><img src="../media/framework/github-logo.png" class="github-mark"></img><img src="../media/framework/github-mark.png" class="github-logo"></img></a><ul class="right hide-on-med-and-down"><li><a href="../install/index.html">Install</a></li><li class="moose-mega-menu-trigger" data-target="7e1fafdb-d9bd-4aca-8d99-4247ecf21af4"><a>Benchmarks<i class="material-icons right">arrow_drop_down</i></a></li><li><a href="../theory/index.html">Theory</a></li><li><a href="../modules/index.html">Modules</a></li><li><a href="../syntax/index.html">Syntax</a></li></ul><a href="#" class="sidenav-trigger" data-target="d2a6e169-d70e-4bb3-aaba-b438b33d1846"><i class="material-icons">menu</i></a><ul class="sidenav" id="d2a6e169-d70e-4bb3-aaba-b438b33d1846"><li><a href="../install/index.html">Install</a></li><li><a href="../benchmarks.menu.html">Benchmarks</a></li><li><a href="../theory/index.html">Theory</a></li><li><a href="../modules/index.html">Modules</a></li><li><a href="../syntax/index.html">Syntax</a></li></ul><a href="#moose-search" class="modal-trigger"><i class="material-icons">search</i></a></div></nav><div class="moose-mega-menu-content" id="7e1fafdb-d9bd-4aca-8d99-4247ecf21af4"><div class="moose-mega-menu-wrapper"><div class="row row"><div class="col s12 m6 l4"><h2 id="mode-i-crack-propagation"><a href="../benchmarks/mode1.html">Mode I crack propagation <i class="material-icons moose-inline-icon">link</i></a></h2><img src="../media/mode1.gif" class="materialboxed moose-image" style="width:75%;float:left;padding-top:2.5%;"></img><p></p></div><div class="col s12 m6 l4"><h2 id="mode-ii-crack-propagation"><a href="../benchmarks/mode2.html">Mode II crack propagation <i class="material-icons moose-inline-icon">link</i></a></h2><img src="../media/mode2.gif" class="materialboxed moose-image" style="width:75%;float:left;padding-top:2.5%;"></img><p></p></div><div class="col s12 m6 l4"><h2 id="soil-desiccation"><a href="../benchmarks/mud.html">Soil desiccation <i class="material-icons moose-inline-icon">link</i></a></h2><img src="../media/soil.gif" class="materialboxed moose-image" style="width:75%;float:left;padding-top:2.5%;"></img><p></p></div></div></div></div><div class="modal modal-fixed-footer moose-search-modal" id="moose-search"><div class="modal-content container moose-search-modal-content"><div class="row"><div class="col l12"><div class="input-field"><input type_="text" onkeyup="mooseSearch()" placeholder="https://hugary1995.github.io/raccoon/index.html" id="moose-search-box"></input></div></div><div><div class="col s12" id="moose-search-results"></div></div></div></div><div class="modal-footer"><a href="#!" class="modal-close btn-flat">Close</a></div></div></header><main class="main"><div class="container"><div class="row"><div class="col hide-on-med-and-down l12"><nav class="breadcrumb-nav"><div class="nav-wrapper"><span class="breadcrumb">finite_volumes</span><a href="#" class="breadcrumb">fv_design</a></div></nav></div></div><div class="row"><div class="moose-content col s12 m12 l10"><section id="3d96d0b4-1765-46b7-b279-4e188ea7677c" data-section-level="1" data-section-text="Finite Volume Design Decisions in MOOSE"><h1 id="finite-volume-design-decisions-in-moose">Finite Volume Design Decisions in MOOSE</h1><p>MOOSE has traditionally been a finite element (FE) framework.  It is built on and takes heavy advantage of the libMesh FE library.  Traditionally, the finite volume (FV) method doesn&#x27;t really have shape-functions to describe continuous solutions within mesh cells.  Instead it uses a constant solution within each mesh element/cell. Because of this, much of MOOSE&#x27;s use of libMesh for FE is not relevant for FV.  This document gives an overview of how FV is similar and different from FE with respect to implementation in MOOSE and explains why FV is designed and implemented in its current form.  In order to fully enable taking advantage of perfomance opportunities and to simplify the FV method implementation in MOOSE, a new set of FV-specific systems was built along-side the MOOSE FE infrastructure.  As a new set of systems being created after MOOSE has received powerful automatic differentiation (AD) support, the FV systems (at least initially) are only being created with AD support in mind, and non-AD (manual jacobian) versions will only be supported if a pressing need arises.</p><section class="scrollspy" id="64a170b0-e09c-49e4-ac20-cde90b50a140" data-section-level="2" data-section-text="Variables"><h2 id="variables">Variables</h2><p>FV-specific (dependent) variable classes were create along side the FE-specific ones sharing common base functionality.  This is responsible for calculating and providing FV cell/face solution values to objects that need them.  Higher-order reconstruction will also be plumbed into here eventually. Ghost cells for boundary conditions and other important functionality is handled automatically at this level so kernel and boundary condition code can be written nearly like the FE equivalents.</p><p>Previously, the variable class hierarchy did not have a field-variable-specific intermediate class.  FV variables, however are field variables that need to be included in some field-variable operations performed in MOOSE.  This was not previously possible because FV variables would have to have shared their entire interface/API with FE variables - which would be a poor choice because of so many non-overlapping API needs between the two (e.g. no shape and test function related functions are needed for FV variables).  So a new field-variable intermediate class was introduced to the variable class heirarchy to facilitate appropriately separate APIs while allowing common operations to be performed on all field variables.</p></section><section class="scrollspy" id="ff1e14ac-9e4d-4a97-83c7-b6430d2b47bf" data-section-level="2" data-section-text="FV Kernels"><h2 id="fv-kernels">FV Kernels</h2><p>Flux Kernels:</p><p>The FV method uses the Gauss-divergence theorem to convert volume integrals with a divergence operator into surface integrals representing flux of various quantities through faces between mesh cells. Unlike FE kernels, no test/weight function is needed.  Coupling between cells occurs from this numerical flux calculation on a face contributing to the mesh cells on both sides of it (with opposing directional sign).  Calculating these numerical fluxes requires access to variable values and properties on both sides of each face.  FE kernels, on the other hand, require only the one set of volumetric/elemental values for the cell of interest.  FV kernels also need to deal with things such as normal face vectors, cross-diffusion correction factors for non-orthogonal meshes, etc.  All these differences make it impractical and messy to try to integrate them both into the same MOOSE kernel system and motivated the decision to create a separate FV kernel system.</p><p>Elemental Kernels:</p><p>The FV method does have some element-based calculations from source and time terms that are just handled/called through the normal FE elemental residual and jacobian mesh loops.  Time derivative kernels and source terms fall in this category.</p></section><section class="scrollspy" id="1efc0df2-ec9f-4540-b49d-b40168c72414" data-section-level="2" data-section-text="Shape Functions and Integration"><h2 id="shape-functions-and-integration">Shape Functions and Integration</h2><p>Because some basic aspects of FV are &quot;simpler&quot; than FE, there is opportunity to operate with a lower computational cost per element than with the FE method.  The FV implementation does the following differently than FE:</p><p>* skips initialization/storage of shape-function data structures</p><p>* skips calculation of dependent variable values at quadrature-points - the   coefficients (degrees of freedom) from the solution vector(s) can be   directly used. FV only needs that one value per cell.</p><p>* skips element integration routines/loops not needed for FV&#x27;s   cell-constant solution.</p><p>Taking full advantage of these and other opportunities will take significant work and FV performance can be expected to improve over time.  Some quadrature point concepts have been retained for FV in MOOSE. This allows for future expansion to higher-order cell solution variable representations in addition to preserving similarity of APIs for users already familiar with MOOSE&#x27;s other objects and systems.</p></section><section class="scrollspy" id="1c4b1da4-03b7-4d9b-8819-213b79fc5b09" data-section-level="2" data-section-text="Looping over Faces"><h2 id="looping-over-faces">Looping over Faces</h2><p>Significant portions of the FV method are naturally cell-face oriented. libMesh does not provide facilities for looping over and working with faces. FV-specific data structures were created to facilitate looping over mesh faces to compute residual contributions from numerical fluxes.</p><p>A face loop was implemented along side existing element, node, etc. loops used for FE.  This is used for calculating numerical flux contributions from FV kernels and boundary conditions.  The face info metadata needed for FV is gathered up front (and recomputed whenever the mesh changes) and cached in MOOSE&#x27;s mesh data structure.  Needs with respect to Dirichlet boundary conditions among other things influenced the decision to have a face info data structure become a hub for objects to retrieve relevant information for calculating residual contributions - more discussion about this is done in the Boundary Conditions section.</p></section><section class="scrollspy" id="39f55793-8ca6-4666-b910-94e652c65d85" data-section-level="2" data-section-text="Boundary Conditions"><h2 id="boundary-conditions">Boundary Conditions</h2><p>Similar reasoning to decisions about the FV kernel system motivated the creation of a separate FV boundary condition system as well.  While FV flux/integrated boundary conditions are somewhat similar to FE integrated BCs, they still lack test/weight functions.  FV Dirichlet BCs, however must be implemented completedly differently than in FE and strongly motivate the creation of a separate FV BC system.</p><p>Dirichlet boundary conditions (BCs) in an FV method cannot be created by directly setting degrees of freedom like in an FE method because the FV degrees of freedom do not exist on the mesh boundary.  There are various approaches for dealing with this in FV.  A ghost-element approach was selected due to its popularity and robustness.  In this approach, Dirichlet BCs are implemented as a weak BC.  To do this, the normal flux kernel terms are applied at the mesh boundary faces.  Since flux kernels are calculated using information from cells on both sides of the face, we use the desired Dirichlet BC value to extrapolate a &quot;ghost&quot; cell value for the side of the face that has no actuall mesh cell.  Other necessary cell properties are also reflected/mirrored from the existing cell.  A design was chosen that allows handling ghost-element creation and use by existing flux kernels automatically for enforcement of Dirichlet BCs.  This procedure results in the Dirichlet BC objects not actually being respondible for calculating residual contributions. They instead inform the ghost-element initialization while the normal flux BCs are used to calculate boundary residual contributions.  This and other differences motivated the creation of a separate FV BC system.</p><p>Many objects in MOOSE get information about the current mesh location by directly accessing their own and inherited member variables.  This becomes somewhat tricky to handle for FV because of the nature of ghost elements. Traditionally, if an object needed the cell volume, it would access an element pointer and use libMesh APIs.  This doesn&#x27;t work for elements that don&#x27;t exist, yet we still need to provide this information for calculating Dirichlet BC residual contributions.  We need to be able to provide information that doesn&#x27;t exist and we need to make sure code doesn&#x27;t try to access irrelevant or wrong information directly from the assembly, FEProblem, or other classes. For this reason, among others, for FV objects the convention has been established for objects to retrieve needed information from a face info object that is passed around rather than retrieving binding references to the usual mesh-related data.  If everyone gets needed information from this one place - it is easy to monitor when code may be doing the wrong thing.  It also becomes a simple matter to provide volumes for non-existing cells and add features that require intercepting and modifying any face information objects need.</p></section><section class="scrollspy" id="4103f8cb-0e7e-4b8a-942f-7c961c9a6f31" data-section-level="2" data-section-text="Reconstruction"><h2 id="reconstruction">Reconstruction</h2><p>TODO: implement reconstruction and discuss design decisions here.</p></section><section class="scrollspy" id="7fe5c385-5dae-4900-9ff3-8bf5947294c3" data-section-level="2" data-section-text="Known Limitations / Issues"><h2 id="known-limitations-issues">Known Limitations/Issues</h2><p>* FE &lt;&mdash;&gt; FV variable-coupling does not work.  Particularly, if FE   variables try to couple to an FV variable, they will segfault when trying to   access quadrature points at any index higher than zero.  Also, FV variables   coupling to FE variables should ideally get a cell-averaged value - but   currently, they will just get the value of the solution at the cell&#x27;s   0-index quadrature point. See   <a href="https://github.com/idaholab/moose/issues/15062">idaholab/moose#15062</a></p><p>* Currently there is no automated handling of cross-diffusion correction   factors for non-orthogonal meshes. See   <a href="https://github.com/idaholab/moose/issues/15063">idaholab/moose#15063</a></p><p>* FV functionality does NOT work with mesh displacements yet. See   <a href="https://github.com/idaholab/moose/issues/15064">idaholab/moose#15064</a></p><p>* Higher order solution reconstruction is not supported yet. See   <a href="https://github.com/idaholab/moose/issues/15066">idaholab/moose#15066</a></p><p>* Have not tested vector-FV varaibles - they almost certainly don&#x27;t work (yet). </p></section></section></div><div class="col hide-on-med-and-down l2"><div class="toc-wrapper pin-top"><ul class="section table-of-contents"><li><a href="#64a170b0-e09c-49e4-ac20-cde90b50a140" class="tooltipped" data-position="left" data-tooltip="Variables">Variables</a></li><li><a href="#ff1e14ac-9e4d-4a97-83c7-b6430d2b47bf" class="tooltipped" data-position="left" data-tooltip="FV Kernels">FV Kernels</a></li><li><a href="#1efc0df2-ec9f-4540-b49d-b40168c72414" class="tooltipped" data-position="left" data-tooltip="Shape Functions and Integration">Shape Functions and Integration</a></li><li><a href="#1c4b1da4-03b7-4d9b-8819-213b79fc5b09" class="tooltipped" data-position="left" data-tooltip="Looping over Faces">Looping over Faces</a></li><li><a href="#39f55793-8ca6-4666-b910-94e652c65d85" class="tooltipped" data-position="left" data-tooltip="Boundary Conditions">Boundary Conditions</a></li><li><a href="#4103f8cb-0e7e-4b8a-942f-7c961c9a6f31" class="tooltipped" data-position="left" data-tooltip="Reconstruction">Reconstruction</a></li><li><a href="#7fe5c385-5dae-4900-9ff3-8bf5947294c3" class="tooltipped" data-position="left" data-tooltip="Known Limitations / Issues">Known Limitations / Issues</a></li></ul></div></div></div></div></main></div></body><script type="text/javascript" src="../contrib/materialize/materialize.min.js"></script><script type="text/javascript" src="../contrib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="../contrib/prism/prism.min.js"></script><script type="text/javascript" src="../js/init.js"></script><script type="text/javascript" src="../js/navigation.js"></script><script type="text/javascript" src="../contrib/fuse/fuse.min.js"></script><script type="text/javascript" src="../js/search_index.js"></script><script type="text/javascript" src="../js/sqa_moose.js"></script>